<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Card - Employee</title>
  <link rel="stylesheet" href="css/style.css" />

  <!-- Screenshot export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Local QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    @media print{
      @page { size: 3.5in 2in; margin: 0; }
      html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>

<body>

<div class="topbar no-print">
  <select id="empSelect"></select>
  <button id="pdfBtn" type="button">Download PDF (3.5x2)</button>
  <a id="openProfileBtn" class="btn" target="_blank" rel="noopener">Open Profile</a>
</div>

<div class="cardWrap">
  <div class="card" id="printCard">
    <div class="cornerAccent" aria-hidden="true"></div>

    <div class="card-inner">
      <!-- LEFT -->
      <div class="left">
        <div class="logoQrStack">
          <a id="logoLink" class="logoLink" target="_blank" rel="noopener" href="#">
            <img id="logoImg" class="logo" alt="Logo" crossorigin="anonymous" />
          </a>

          <div class="qrWrap">
            <img id="qrImg" class="qrImg" alt="QR" crossorigin="anonymous" />
          </div>
        </div>
      </div>

      <div class="divider" aria-hidden="true"></div>

      <!-- RIGHT -->
      <div class="right">
        <div class="nameRow">
          <div class="userIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0 2c-3.34 0-10 1.67-10 5v3h20v-3c0-3.33-6.66-5-10-5z"/>
            </svg>
          </div>
          <div class="nameBlock">
            <div class="name" id="name">â€”</div>
            <div class="designation" id="designation">â€”</div>
          </div>
        </div>

        <div class="meta">
          <div class="row">
            <a id="phoneIcon" class="iconBox iconLink" href="#" aria-label="Call">
              <svg viewBox="0 0 24 24">
                <path d="M6.6 10.8c1.4 2.7 3.9 5.2 6.6 6.6l2.2-2.2c.3-.3.7-.4 1.1-.3 1.2.4 2.6.6 3.9.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.8 21 3 13.2 3 3c0-.6.4-1 1-1h3.2c.6 0 1 .4 1 1 0 1.3.2 2.7.6 3.9.1.4 0 .8-.3 1.1L6.6 10.8z"/>
              </svg>
            </a>
            <div class="value" id="phone">â€”</div>
          </div>

          <div class="row">
            <a id="emailIcon" class="iconBox iconLink" href="#" aria-label="Email">
              <svg viewBox="0 0 24 24">
                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
            </a>
            <div class="value" id="email">â€”</div>
          </div>

          <div class="row">
            <a id="webIcon" class="iconBox iconLink" href="#" target="_blank" rel="noopener" aria-label="Website">
              <svg viewBox="0 0 24 24">
                <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm7.93 9h-3.18a15.7 15.7 0 00-2.06-5.58A8.02 8.02 0 0119.93 11zM12 4.07c1.02 1.35 1.86 3.55 2.14 6.93H9.86c.28-3.38 1.12-5.58 2.14-6.93zM4.07 13h3.18c.23 2.12.9 4.02 2.06 5.58A8.02 8.02 0 014.07 13zm3.18-2H4.07a8.02 8.02 0 015.24-5.58A15.7 15.7 0 007.25 11zM12 19.93c-1.02-1.35-1.86-3.55-2.14-6.93h4.28c-.28 3.38-1.12 5.58-2.14 6.93zM16.75 13h3.18a8.02 8.02 0 01-5.24 5.58c1.16-1.56 1.83-3.46 2.06-5.58z"/>
              </svg>
            </a>
            <div class="value" id="website">â€”</div>
          </div>

          <div class="row addressRow">
            <span class="iconBox" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/>
              </svg>
            </span>
            <a class="addrText addrLink" id="address" href="#" target="_blank" rel="noopener">â€”</a>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
const PROFILE_ROOT = "https://visargbhatporiya.github.io/employee-icard/";
let EMPLOYEES = [];
let CURRENT_EMP = null;

// We'll store these so PDF can add clickable links
let CURRENT_PROFILE_URL = "";
let CURRENT_WEB_URL = "";
let CURRENT_TEL_URL = "";
let CURRENT_MAIL_URL = "";
let CURRENT_MAP_URL = "";


function text(id, v){ document.getElementById(id).textContent = (v && String(v).trim()) ? v : "â€”"; }
function html(id, v){ document.getElementById(id).innerHTML = v || "â€”"; }

function normalizeUrl(url){
  if(!url) return "";
  const u = String(url).trim();
  if(!u) return "";
  if(u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u;
}

async function makeQrDataUrl(data){
  try{
    if(window.QRCode && QRCode.toDataURL){
      return await QRCode.toDataURL(String(data || ""), { width: 400, margin: 0 });
    }
  }catch(e){ console.warn("QR generation failed, fallback", e); }
  const d = encodeURIComponent(data || "");
  return `https://api.qrserver.com/v1/create-qr-code/?size=400x400&margin=0&data=${d}`;
}

function buildProfileUrl(empId){ return `${PROFILE_ROOT}?id=${encodeURIComponent(empId)}`; }

function setIconLink(el, href){
  if(!el) return;
  if(href){ el.href = href; el.style.pointerEvents="auto"; el.style.opacity="1"; }
  else{ el.href="#"; el.style.pointerEvents="none"; el.style.opacity=".45"; }
}

function buildMapUrl(addr){
  const a = (addr || "").toString().trim();
  if(!a || a === "â€”") return "";
  return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(a);
}


function waitForImg(img){
  return new Promise((resolve) => {
    if(!img) return resolve();
    if(img.complete && img.naturalWidth > 0) return resolve();
    img.onload = () => resolve();
    img.onerror = () => resolve();
  });
}

function setEmployee(e){
  CURRENT_EMP = e;

  const name = e.name || e.fullName || e.employeeName || "â€”";
  const des  = e.designation || e.role || e.title || "â€”";
  const address = e.address || e.location || e.addr || "â€”";

  const phone = (e.phone || e.mobile || e.contact || "").toString().trim();
  const email = (e.email || e.mail || "").toString().trim();
  const websiteRaw = (e.website || e.web || e.site || "").toString().trim();
  const websiteUrl = websiteRaw ? normalizeUrl(websiteRaw) : "";

  text("name", name);
  text("designation", des);
// âœ… Address clickable (Google Maps)
CURRENT_MAP_URL = buildMapUrl(address);

const addrEl = document.getElementById("address");
if(addrEl){
  addrEl.textContent = (address && String(address).trim()) ? address : "â€”";

  if(CURRENT_MAP_URL){
    addrEl.href = CURRENT_MAP_URL;
    addrEl.style.pointerEvents = "auto";
    addrEl.style.opacity = "1";
  }else{
    addrEl.href = "#";
    addrEl.style.pointerEvents = "none";
    addrEl.style.opacity = ".9";
  }
}

  // Save for PDF click
  CURRENT_TEL_URL = phone ? `tel:${phone.replace(/\s+/g,"")}` : "";
  CURRENT_MAIL_URL = email ? `mailto:${email}` : "";
  CURRENT_WEB_URL  = websiteRaw ? websiteUrl : "";

  if(phone){
    html("phone", `<a href="${CURRENT_TEL_URL}">${phone}</a>`);
  }else text("phone","â€”");

  if(email){
    html("email", `<a href="${CURRENT_MAIL_URL}">${email}</a>`);
  }else text("email","â€”");

  if(websiteRaw){
    const showText = websiteRaw.replace(/^https?:\/\//i, "").replace(/\/+$/,"");
    html("website", `<a href="${CURRENT_WEB_URL}" target="_blank" rel="noopener">${showText}</a>`);
  }else text("website","â€”");

  setIconLink(document.getElementById("phoneIcon"), CURRENT_TEL_URL);
  setIconLink(document.getElementById("emailIcon"), CURRENT_MAIL_URL);
  setIconLink(document.getElementById("webIcon"), CURRENT_WEB_URL);

  // logo
  const logo = e.logo || e.logoUrl || e.logoImage || "";
  const logoImg = document.getElementById("logoImg");
  if(logo){
    logoImg.src = logo;
  }else{
    logoImg.src = "data:image/svg+xml;utf8," + encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'>
        <rect x='6' y='6' width='168' height='168' fill='white' stroke='black' stroke-width='2'/>
        <text x='50%' y='55%' font-size='22' text-anchor='middle' fill='black'
              font-family='Arial' font-weight='700'>LOGO</text>
      </svg>
    `);
  }

  // profile url
  const fallbackIndex = document.getElementById("empSelect").value || "0";
  const empId = (e.id || e.empId || e.slug || fallbackIndex);
  CURRENT_PROFILE_URL = buildProfileUrl(empId);
  document.getElementById("openProfileBtn").href = CURRENT_PROFILE_URL;

  // qr
  const qrEl = document.getElementById("qrImg");
  makeQrDataUrl(CURRENT_PROFILE_URL).then(src => { qrEl.src = src; });

  // logo click -> website
  const logoLink = document.getElementById("logoLink");
  if(CURRENT_WEB_URL){
    logoLink.href = CURRENT_WEB_URL;
    logoLink.style.pointerEvents = "auto";
    logoLink.style.opacity = "1";
  }else{
    logoLink.href = "#";
    logoLink.style.pointerEvents = "none";
    logoLink.style.opacity = ".7";
  }
}

async function loadEmployees(){
  const sel = document.getElementById("empSelect");
  sel.innerHTML = `<option>Loadingâ€¦</option>`;
  try{
    const res = await fetch("./employees.json", { cache:"no-store" });
    if(!res.ok) throw new Error("employees.json not found");
    const data = await res.json();
    EMPLOYEES = Array.isArray(data) ? data : (data.employees || []);
    if(!EMPLOYEES.length) throw new Error("No employees in JSON");

    sel.innerHTML = "";
    EMPLOYEES.forEach((e,i)=>{
      const label = e.name || e.fullName || e.employeeName || `Employee ${i+1}`;
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = label;
      sel.appendChild(opt);
    });

    sel.onchange = () => setEmployee(EMPLOYEES[Number(sel.value)]);
    sel.value = "0";
    setEmployee(EMPLOYEES[0]);

  }catch(err){
    console.error(err);
    sel.innerHTML = `<option>Error: ${err.message}</option>`;
  }
}

/** Add clickable rectangle (in inches) */
function addLink(pdf, url, x, y, w, h){
  if(!url) return;
  pdf.link(x, y, w, h, { url });
}

/* âœ… PERFECT PDF ONLY (no style/json changes) */
async function downloadCardPdf(){
  const card = document.getElementById("printCard");

  document.body.classList.add("exporting");
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

  if (document.fonts?.ready) { try { await document.fonts.ready; } catch(e){} }
  await Promise.all([
    waitForImg(document.getElementById("logoImg")),
    waitForImg(document.getElementById("qrImg"))
  ]);

  const rect = card.getBoundingClientRect();
  const SCALE = 4;

  const canvas = await html2canvas(card, {
    backgroundColor: "#ffffff",
    scale: SCALE,
    width: rect.width,
    height: rect.height,
    useCORS: true,
    allowTaint: false,
    logging: false,
    onclone: (doc) => {
  doc.body.classList.add("exporting");

  const logoLink = doc.getElementById("logoLink");
  const logoImg  = doc.getElementById("logoImg");

  if (logoLink){
    logoLink.style.borderRadius = "0";
    logoLink.style.overflow = "visible";
    logoLink.style.clipPath = "none";
    logoLink.style.webkitClipPath = "none";

    /* ðŸ”½ PDF ONLY logo container size */
    logoLink.style.width = "78px";
    logoLink.style.height = "78px";
  }

  if (logoImg){
    logoImg.style.borderRadius = "0";
    logoImg.style.clipPath = "none";
    logoImg.style.webkitClipPath = "none";
    logoImg.style.objectFit = "contain";

    /* ðŸ”½ PDF ONLY logo image size */
    logoImg.style.width = "78px";
    logoImg.style.height = "78px";
  }
}

  });

  const imgData = canvas.toDataURL("image/png", 1.0);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: "landscape",
    unit: "in",
    format: [3.5, 2],
    compress: false
  });

  pdf.addImage(imgData, "PNG", 0, 0, 3.5, 2, undefined, "NONE");

  addLink(pdf, CURRENT_WEB_URL,     0.22, 0.18, 1.05, 0.85);
  addLink(pdf, CURRENT_PROFILE_URL, 0.36, 1.12, 0.70, 0.70);
  addLink(pdf, CURRENT_TEL_URL,     1.55, 0.55, 1.85, 0.22);
  addLink(pdf, CURRENT_MAIL_URL,    1.55, 0.80, 1.85, 0.22);
  addLink(pdf, CURRENT_WEB_URL,     1.55, 1.05, 1.85, 0.22);
  addLink(pdf, CURRENT_MAP_URL,     1.55, 1.30, 1.85, 0.60);


  const safeName = (document.getElementById("name")?.textContent || "card")
    .trim().replace(/\s+/g, "-").replace(/[^a-z0-9\-]/gi, "");

  pdf.save(`${safeName || "qr-card"}.pdf`);

  document.body.classList.remove("exporting");
}

/* âœ… REQUIRED INIT (you were missing this) */
document.getElementById("pdfBtn").addEventListener("click", downloadCardPdf);
loadEmployees();
</script>

</body>
</html>
