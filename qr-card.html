<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Card - Employee</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>

<div class="topbar no-print">
  <select id="empSelect"></select>
  <button id="pdfBtn" type="button">Download PDF (3.5x2)</button>
  <a id="openProfileBtn" class="btn" target="_blank" rel="noopener">Open Profile</a>
</div>

<!-- CARD -->
<div class="cardWrap">
  <div class="card" id="printCard">

    <!-- top-left black rounded pattern -->
    <div class="cornerAccent" aria-hidden="true"></div>

    <div class="card-inner">
      <!-- LEFT SIDE -->
      <div class="left">
        <a id="logoLink" class="logoLink" target="_blank" rel="noopener" href="#">
          <img id="logoImg" class="logo" alt="Logo" />
        </a>

        <div class="qrWrap">
          <img id="qrImg" class="qrImg" alt="QR" />
        </div>
      </div>

      <!-- DIVIDER -->
      <div class="divider" aria-hidden="true"></div>

      <!-- RIGHT SIDE -->
      <div class="right">

        <!-- NAME + USER ICON -->
        <div class="nameRow">
          <div class="userIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0 2c-3.34 0-10 1.67-10 5v3h20v-3c0-3.33-6.66-5-10-5z"/>
            </svg>
          </div>
          <div>
            <div class="name" id="name">—</div>
            <div class="designation" id="designation">—</div>
          </div>
        </div>

        <!-- CONTACTS -->
        <div class="meta">

          <div class="row">
            <a id="phoneIcon" class="iconBox iconLink" href="#" aria-label="Call">
              <svg viewBox="0 0 24 24">
                <path d="M6.6 10.8c1.4 2.7 3.9 5.2 6.6 6.6l2.2-2.2c.3-.3.7-.4 1.1-.3 1.2.4 2.6.6 3.9.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.8 21 3 13.2 3 3c0-.6.4-1 1-1h3.2c.6 0 1 .4 1 1 0 1.3.2 2.7.6 3.9.1.4 0 .8-.3 1.1L6.6 10.8z"/>
              </svg>
            </a>
            <div class="value" id="phone">—</div>
          </div>

          <div class="row">
            <a id="emailIcon" class="iconBox iconLink" href="#" aria-label="Email">
              <svg viewBox="0 0 24 24">
                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
            </a>
            <div class="value" id="email">—</div>
          </div>

          <div class="row">
            <a id="webIcon" class="iconBox iconLink" href="#" target="_blank" rel="noopener" aria-label="Website">
              <svg viewBox="0 0 24 24">
                <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm7.93 9h-3.18a15.7 15.7 0 00-2.06-5.58A8.02 8.02 0 0119.93 11zM12 4.07c1.02 1.35 1.86 3.55 2.14 6.93H9.86c.28-3.38 1.12-5.58 2.14-6.93zM4.07 13h3.18c.23 2.12.9 4.02 2.06 5.58A8.02 8.02 0 014.07 13zm3.18-2H4.07a8.02 8.02 0 015.24-5.58A15.7 15.7 0 007.25 11zM12 19.93c-1.02-1.35-1.86-3.55-2.14-6.93h4.28c-.28 3.38-1.12 5.58-2.14 6.93zM16.75 13h3.18a8.02 8.02 0 01-5.24 5.58c1.16-1.56 1.83-3.46 2.06-5.58z"/>
              </svg>
            </a>
            <div class="value" id="website">—</div>
          </div>

          <div class="row addressRow">
            <span class="iconBox" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/>
              </svg>
            </span>
            <div class="addrText" id="address">—</div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ========= CONFIG ========= */
const PROFILE_ROOT = "https://visargbhatporiya.github.io/employee-icard/";

/* ========= STATE ========= */
let EMPLOYEES = [];
let CURRENT_EMP = null;

/* ========= HELPERS ========= */
function text(id, v){
  document.getElementById(id).textContent = (v && String(v).trim()) ? v : "—";
}
function html(id, v){
  document.getElementById(id).innerHTML = v || "—";
}
function normalizeUrl(url){
  if(!url) return "";
  const u = String(url).trim();
  if(!u) return "";
  if(u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u;
}
function makeQrUrl(data){
  const d = encodeURIComponent(data || "");
  return `https://api.qrserver.com/v1/create-qr-code/?size=400x400&margin=0&data=${d}`;
}
function buildProfileUrl(empId){
  return `${PROFILE_ROOT}?id=${encodeURIComponent(empId)}`;
}
function setIconLink(el, href){
  if(!el) return;
  if(href){
    el.href = href;
    el.style.pointerEvents = "auto";
    el.style.opacity = "1";
  }else{
    el.href = "#";
    el.style.pointerEvents = "none";
    el.style.opacity = ".45";
  }
}

/* ========= RENDER ========= */
function setEmployee(e){
  CURRENT_EMP = e;

  const name = e.name || e.fullName || e.employeeName || "—";
  const des  = e.designation || e.role || e.title || "—";
  const address = e.address || e.location || e.addr || "—";

  const phone = (e.phone || e.mobile || e.contact || "").toString().trim();
  const email = (e.email || e.mail || "").toString().trim();
  const websiteRaw = (e.website || e.web || e.site || "").toString().trim();
  const websiteUrl = websiteRaw ? normalizeUrl(websiteRaw) : "";

  text("name", name);
  text("designation", des);
  text("address", address);

  // clickable values
  let telHref = "";
  if(phone){
    const tel = phone.replace(/\s+/g,"");
    telHref = `tel:${tel}`;
    html("phone", `<a href="${telHref}">${phone}</a>`);
  }else text("phone","—");

  let mailHref = "";
  if(email){
    mailHref = `mailto:${email}`;
    html("email", `<a href="${mailHref}">${email}</a>`);
  }else text("email","—");

  let webHref = "";
if (websiteRaw) {
  webHref = websiteUrl;

  // ✅ show clean domain like "www.ddsengineering.in"
  const showText = websiteRaw
    .replace(/^https?:\/\//i, "")
    .replace(/\/+$/,"");

  html("website", `<a href="${webHref}" target="_blank" rel="noopener">${showText}</a>`);
} else {
  text("website", "—");
}


  // icons clickable
  setIconLink(document.getElementById("phoneIcon"), telHref);
  setIconLink(document.getElementById("emailIcon"), mailHref);
  setIconLink(document.getElementById("webIcon"), webHref);

  // logo
  const logo = e.logo || e.logoUrl || e.logoImage || "";
  const logoImg = document.getElementById("logoImg");
  if(logo){
    logoImg.src = logo;
  }else{
    logoImg.src = "data:image/svg+xml;utf8," + encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'>
        <circle cx='90' cy='90' r='84' fill='white' stroke='black' stroke-width='2'/>
        <text x='50%' y='55%' font-size='22' text-anchor='middle' fill='black'
              font-family='Arial' font-weight='700'>LOGO</text>
      </svg>
    `);
  }

  // profile url (?id=)
  const fallbackIndex = document.getElementById("empSelect").value || "0";
  const empId = (e.id || e.empId || e.slug || fallbackIndex);
  const profilePageUrl = buildProfileUrl(empId);

  // Open Profile
  const openBtn = document.getElementById("openProfileBtn");
  openBtn.href = profilePageUrl;

  // QR
  document.getElementById("qrImg").src = makeQrUrl(profilePageUrl);

  // Logo opens website
  const logoLink  = document.getElementById("logoLink");
  if(webHref){
    logoLink.href = webHref;
    logoLink.style.pointerEvents = "auto";
    logoLink.style.opacity = "1";
  }else{
    logoLink.href = "#";
    logoLink.style.pointerEvents = "none";
    logoLink.style.opacity = ".7";
  }
}

/* ========= LOAD employees.json ========= */
async function loadEmployees(){
  const sel = document.getElementById("empSelect");
  sel.innerHTML = `<option>Loading…</option>`;

  try{
    const res = await fetch("./employees.json", { cache:"no-store" });
    if(!res.ok) throw new Error("employees.json not found");

    const data = await res.json();
    EMPLOYEES = Array.isArray(data) ? data : (data.employees || []);
    if(!EMPLOYEES.length) throw new Error("No employees in JSON");

    sel.innerHTML = "";
    EMPLOYEES.forEach((e,i)=>{
      const label = e.name || e.fullName || e.employeeName || `Employee ${i+1}`;
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = label;
      sel.appendChild(opt);
    });

    sel.onchange = () => setEmployee(EMPLOYEES[Number(sel.value)]);
    sel.value = "0";
    setEmployee(EMPLOYEES[0]);

  }catch(err){
    console.error(err);
    sel.innerHTML = `<option>Error: ${err.message}</option>`;
  }
}

/* ========= PDF (3.5x2) + clickable links ========= */
async function downloadCardPdf(){
  const el = document.getElementById("printCard");

  const canvas = await html2canvas(el, {
    scale: 3,
    useCORS: true,
    backgroundColor: "#ffffff"
  });

  const img = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;

  const pdfW = 3.5, pdfH = 2;
  const pdf = new jsPDF({ orientation:"landscape", unit:"in", format:[pdfW, pdfH] });
  pdf.addImage(img, "PNG", 0, 0, pdfW, pdfH);

  const cardRect = el.getBoundingClientRect();
  function rectToPdf(rect){
    const x = ((rect.left - cardRect.left) / cardRect.width) * pdfW;
    const y = ((rect.top - cardRect.top) / cardRect.height) * pdfH;
    const w = (rect.width / cardRect.width) * pdfW;
    const h = (rect.height / cardRect.height) * pdfH;
    return { x,y,w,h };
  }
  function addLink(domEl, url){
    if(!domEl || !url) return;
    const r = domEl.getBoundingClientRect();
    const p = rectToPdf(r);
    pdf.link(p.x, p.y, p.w, p.h, { url, newWindow:true });
  }

  addLink(el.querySelector("#phone a"), el.querySelector("#phone a")?.href);
  addLink(el.querySelector("#email a"), el.querySelector("#email a")?.href);
  addLink(el.querySelector("#website a"), el.querySelector("#website a")?.href);

  addLink(el.querySelector("#phoneIcon"), el.querySelector("#phoneIcon")?.href);
  addLink(el.querySelector("#emailIcon"), el.querySelector("#emailIcon")?.href);
  addLink(el.querySelector("#webIcon"), el.querySelector("#webIcon")?.href);

  const addr = (CURRENT_EMP?.address || CURRENT_EMP?.location || "").trim();
  if(addr){
    addLink(el.querySelector("#address"), `https://www.google.com/maps?q=${encodeURIComponent(addr)}`);
  }

  const fallbackIndex = document.getElementById("empSelect").value || "0";
  const empId = (CURRENT_EMP?.id || CURRENT_EMP?.empId || CURRENT_EMP?.slug || fallbackIndex);
  addLink(el.querySelector("#qrImg"), buildProfileUrl(empId));

  const websiteRaw = CURRENT_EMP?.website || CURRENT_EMP?.web || CURRENT_EMP?.site || "";
  const websiteUrl = websiteRaw ? normalizeUrl(websiteRaw) : "";
  if(websiteUrl){
    addLink(el.querySelector("#logoImg"), websiteUrl);
  }

  const filename = (CURRENT_EMP?.name ? CURRENT_EMP.name.replace(/\s+/g,"_") : "employee") + ".pdf";
  pdf.save(filename);
}

/* ========= INIT ========= */
document.getElementById("pdfBtn").addEventListener("click", downloadCardPdf);
loadEmployees();
</script>

</body>
</html>
