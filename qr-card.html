<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Card - Employee</title>

  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
<div class="topbar">
  <select id="empSelect"></select>
  <button id="pdfBtn" type="button">Download PDF (3.5x2)</button>
  <a id="openProfileBtn" class="btn" target="_blank" rel="noopener">Open Profile</a>
</div>

<div class="card" id="printCard">
  <div class="card-inner">

    <!-- ===== TOP ROW (Logo | Name+Designation) ===== -->
    <div class="top-left">
      <a id="logoLink" class="logoLink" target="_blank" rel="noopener" href="#">
        <img id="logoImg" class="logo" alt="Logo">
      </a>
    </div>

    <div class="top-right">
      <div class="name" id="name">—</div>
      <div class="designation" id="designation">—</div>
    </div>

    <!-- ===== BOTTOM ROW (QR | Details) ===== -->
    <div class="bottom-left">
      <div class="qrWrap">
        <div class="qr">
          <img id="qrImg" alt="QR">
        </div>
      </div>
    </div>

    <div class="bottom-right">
      <div class="company" id="company">—</div>
      <div class="addr" id="address">—</div>

      <!-- ✅ Icons + values (ALL clickable) -->
      <div class="meta">

        <!-- PHONE -->
        <a id="phoneIcon" class="label iconLink" href="#" aria-label="Call">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6.6 10.8c1.4 2.7 3.9 5.2 6.6 6.6l2.2-2.2c.3-.3.7-.4 1.1-.3 1.2.4 2.6.6 3.9.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.8 21 3 13.2 3 3c0-.6.4-1 1-1h3.2c.6 0 1 .4 1 1 0 1.3.2 2.7.6 3.9.1.4 0 .8-.3 1.1L6.6 10.8z"/>
          </svg>
        </a>
        <div class="colon">:</div>
        <div class="value" id="phone">—</div>

        <!-- EMAIL -->
        <a id="emailIcon" class="label iconLink" href="#" aria-label="Email">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/>
          </svg>
        </a>
        <div class="colon">:</div>
        <div class="value" id="email">—</div>

        <!-- WEBSITE -->
        <a id="webIcon" class="label iconLink" href="#" target="_blank" rel="noopener" aria-label="Website">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm7.9 9h-3.2c-.2-2.1-.9-4-2-5.6 2.6 1 4.5 3.2 5.2 5.6zM12 4.1c1.2 1.6 2 3.9 2.2 6.9H9.8c.2-3 .9-5.3 2.2-6.9zM4.1 13h3.2c.2 2.1.9 4 2 5.6-2.6-1-4.5-3.2-5.2-5.6zm3.2-2H4.1c.7-2.4 2.6-4.6 5.2-5.6-1.1 1.6-1.8 3.5-2 5.6zM12 19.9c-1.2-1.6-2-3.9-2.2-6.9h4.4c-.2 3-.9 5.3-2.2 6.9zM16.7 13h3.2c-.7 2.4-2.6-4.6-5.2 5.6 1.1-1.6 1.8-3.5 2-5.6z"/>
          </svg>
        </a>
        <div class="colon">:</div>
        <div class="value" id="website">—</div>

      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ========= CONFIG ========= */
const PROFILE_ROOT = "https://visargbhatporiya.github.io/employee-icard/";

/* ========= STATE ========= */
let EMPLOYEES = [];
let CURRENT_EMP = null;

/* ========= HELPERS ========= */
function text(id, v){
  document.getElementById(id).textContent = (v && String(v).trim()) ? v : "—";
}
function html(id, v){
  document.getElementById(id).innerHTML = v || "—";
}
function normalizeUrl(url){
  if(!url) return "";
  const u = String(url).trim();
  if(!u) return "";
  if(u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u;
}
function makeQrUrl(data){
  const d = encodeURIComponent(data || "");
  return `https://api.qrserver.com/v1/create-qr-code/?size=260x260&margin=0&data=${d}`;
}

/* ✅ Build profile URL using ?id= */
function buildProfileUrl(empId){
  return `${PROFILE_ROOT}?id=${encodeURIComponent(empId)}`;
}

function setIconLink(el, href){
  if(!el) return;
  if(href){
    el.href = href;
    el.style.pointerEvents = "auto";
    el.style.opacity = "1";
  }else{
    el.href = "#";
    el.style.pointerEvents = "none";
    el.style.opacity = ".45";
  }
}

/* ========= RENDER ========= */
function setEmployee(e){
  CURRENT_EMP = e;

  const name = e.name || e.fullName || e.employeeName || "—";
  const des  = e.designation || e.role || e.title || "—";
  const company = e.company || e.companyName || "DDS Engineering (India) Private Limited";
  const address = e.address || e.location || e.addr || "—";

  const phone = (e.phone || e.mobile || e.contact || "").toString().trim();
  const email = (e.email || e.mail || "").toString().trim();
  const websiteRaw = (e.website || e.web || e.site || "").toString().trim();
  const websiteUrl = websiteRaw ? normalizeUrl(websiteRaw) : "";

  text("name", name);
  text("designation", des);
  text("company", company);
  text("address", address);

  // values clickable
  let telHref = "";
  if(phone){
    const tel = phone.replace(/\s+/g,"");
    telHref = `tel:${tel}`;
    html("phone", `<a href="${telHref}">${phone}</a>`);
  }else{
    text("phone","—");
  }

  let mailHref = "";
  if(email){
    mailHref = `mailto:${email}`;
    html("email", `<a href="${mailHref}">${email}</a>`);
  }else{
    text("email","—");
  }

  let webHref = "";
  if(websiteRaw){
    webHref = websiteUrl;
    html("website", `<a href="${webHref}" target="_blank" rel="noopener">${websiteRaw}</a>`);
  }else{
    text("website","—");
  }

  // ✅ icons clickable (same href as values)
  setIconLink(document.getElementById("phoneIcon"), telHref);
  setIconLink(document.getElementById("emailIcon"), mailHref);
  setIconLink(document.getElementById("webIcon"), webHref);

  // Logo
  const logo = e.logo || e.logoUrl || e.logoImage || "";
  const logoImg = document.getElementById("logoImg");
  if(logo){
    logoImg.src = logo;
  }else{
    logoImg.src = "data:image/svg+xml;utf8," + encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>
        <circle cx='60' cy='60' r='58' fill='white' stroke='rgba(0,0,0,.10)'/>
        <text x='50%' y='55%' font-size='18' text-anchor='middle' fill='#111827' font-family='Arial' font-weight='700'>LOGO</text>
      </svg>
    `);
  }

  /* ✅ IMPORTANT:
     Profile page expects ?id=<employee-id>
     So QR must send e.id (like "ankit"), NOT 0/1
  */
  const fallbackIndex = document.getElementById("empSelect").value || "0";
  const empId = (e.id || e.empId || e.slug || fallbackIndex);
  const profilePageUrl = buildProfileUrl(empId);

  // Open Profile
  const openBtn = document.getElementById("openProfileBtn");
  openBtn.href = profilePageUrl;
  openBtn.style.opacity = "1";
  openBtn.style.pointerEvents = "auto";

  // QR
  document.getElementById("qrImg").src = makeQrUrl(profilePageUrl);

  // Logo opens WEBSITE
  const logoLink  = document.getElementById("logoLink");
  if(webHref){
    logoLink.href = webHref;
    logoLink.style.pointerEvents = "auto";
    logoLink.style.opacity = "1";
  }else{
    logoLink.href = "#";
    logoLink.style.pointerEvents = "none";
    logoLink.style.opacity = ".7";
  }
}

/* ========= LOAD employees.json ========= */
async function loadEmployees(){
  const sel = document.getElementById("empSelect");
  sel.innerHTML = `<option>Loading…</option>`;

  try{
    const res = await fetch("./employees.json", { cache:"no-store" });
    if(!res.ok) throw new Error("employees.json not found");

    const data = await res.json();
    EMPLOYEES = Array.isArray(data) ? data : (data.employees || []);
    if(!EMPLOYEES.length) throw new Error("No employees in JSON");

    sel.innerHTML = "";
    EMPLOYEES.forEach((e,i)=>{
      const label = e.name || e.fullName || e.employeeName || `Employee ${i+1}`;
      const opt = document.createElement("option");
      opt.value = String(i);   // ✅ always index
      opt.textContent = label;
      sel.appendChild(opt);
    });

    sel.onchange = () => setEmployee(EMPLOYEES[Number(sel.value)]);
    sel.value = "0";
    setEmployee(EMPLOYEES[0]);

  }catch(err){
    console.error(err);
    sel.innerHTML = `<option>Error: ${err.message}</option>`;
  }
}

/* ========= PDF (3.5x2) + clickable links ========= */
async function downloadCardPdf(){
  const el = document.getElementById("printCard");

  const canvas = await html2canvas(el, {
    scale: 3,
    useCORS: true,
    backgroundColor: "#ffffff"
  });

  const img = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;

  const pdfW = 3.5, pdfH = 2;
  const pdf = new jsPDF({ orientation:"landscape", unit:"in", format:[pdfW, pdfH] });

  pdf.addImage(img, "PNG", 0, 0, pdfW, pdfH);

  const cardRect = el.getBoundingClientRect();
  function rectToPdf(rect){
    const x = ((rect.left - cardRect.left) / cardRect.width) * pdfW;
    const y = ((rect.top - cardRect.top) / cardRect.height) * pdfH;
    const w = (rect.width / cardRect.width) * pdfW;
    const h = (rect.height / cardRect.height) * pdfH;
    return { x,y,w,h };
  }
  function addLink(domEl, url){
    if(!domEl || !url) return;
    const r = domEl.getBoundingClientRect();
    const p = rectToPdf(r);
    pdf.link(p.x, p.y, p.w, p.h, { url, newWindow:true });
  }

  // values links
  addLink(el.querySelector("#phone a"), el.querySelector("#phone a")?.href);
  addLink(el.querySelector("#email a"), el.querySelector("#email a")?.href);
  addLink(el.querySelector("#website a"), el.querySelector("#website a")?.href);

  // icon links
  addLink(el.querySelector("#phoneIcon"), el.querySelector("#phoneIcon")?.href);
  addLink(el.querySelector("#emailIcon"), el.querySelector("#emailIcon")?.href);
  addLink(el.querySelector("#webIcon"), el.querySelector("#webIcon")?.href);

  // address to maps
  const addrEl = el.querySelector("#address");
  const addr = (CURRENT_EMP?.address || CURRENT_EMP?.location || "").trim();
  if(addr){
    addLink(addrEl, `https://www.google.com/maps?q=${encodeURIComponent(addr)}`);
  }

  // ✅ QR opens profile (?id=)
  const qrEl = el.querySelector("#qrImg");
  const fallbackIndex = document.getElementById("empSelect").value || "0";
  const empId = (CURRENT_EMP?.id || CURRENT_EMP?.empId || CURRENT_EMP?.slug || fallbackIndex);
  addLink(qrEl, buildProfileUrl(empId));

  // Logo opens website
  const websiteRaw = CURRENT_EMP?.website || CURRENT_EMP?.web || CURRENT_EMP?.site || "";
  const websiteUrl = websiteRaw ? normalizeUrl(websiteRaw) : "";
  const logoEl = el.querySelector("#logoImg");
  if(websiteUrl){
    addLink(logoEl, websiteUrl);
  }

  const filename = (CURRENT_EMP?.name ? CURRENT_EMP.name.replace(/\s+/g,"_") : "employee") + ".pdf";
  pdf.save(filename);
}

/* ========= INIT ========= */
document.getElementById("pdfBtn").addEventListener("click", downloadCardPdf);
loadEmployees();
</script>

</body>
</html>
