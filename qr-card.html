<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Card - Employee</title>
  <link rel="stylesheet" href="css/style.css" />

  <!-- Export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Local QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    @media print{
      @page { size: 3.5in 2in; margin: 0; }
      html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>

<body>

<div class="topbar no-print">
  <select id="empSelect"></select>
  <button id="pdfBtn" type="button">Download PDF (3.5x2)</button>
  <a id="openProfileBtn" class="btn" target="_blank" rel="noopener">Open Profile</a>
</div>

<div class="cardWrap">
  <div class="card" id="printCard">
    <div class="cornerAccent" aria-hidden="true"></div>

    <div class="card-inner">
      <!-- LEFT -->
      <div class="left">
        <div class="logoQrStack">
          <a id="logoLink" class="logoLink" target="_blank" rel="noopener" href="#">
            <img id="logoImg" class="logo" alt="Logo" />
          </a>

          <div class="qrWrap">
            <img id="qrImg" class="qrImg" alt="QR" />
          </div>
        </div>
      </div>

      <div class="divider" aria-hidden="true"></div>

      <!-- RIGHT -->
      <div class="right">
        <div class="nameRow">
          <div class="userIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0 2c-3.34 0-10 1.67-10 5v3h20v-3c0-3.33-6.66-5-10-5z"/>
            </svg>
          </div>
          <div class="nameBlock">
            <div class="name" id="name">—</div>
            <div class="designation" id="designation">—</div>
          </div>
        </div>

        <div class="meta">
          <div class="row">
            <a id="phoneIcon" class="iconBox iconLink" href="#" aria-label="Call">
              <svg viewBox="0 0 24 24">
                <path d="M6.6 10.8c1.4 2.7 3.9 5.2 6.6 6.6l2.2-2.2c.3-.3.7-.4 1.1-.3 1.2.4 2.6.6 3.9.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.8 21 3 13.2 3 3c0-.6.4-1 1-1h3.2c.6 0 1 .4 1 1 0 1.3.2 2.7.6 3.9.1.4 0 .8-.3 1.1L6.6 10.8z"/>
              </svg>
            </a>
            <div class="value" id="phone">—</div>
          </div>

          <div class="row">
            <a id="emailIcon" class="iconBox iconLink" href="#" aria-label="Email">
              <svg viewBox="0 0 24 24">
                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
            </a>
            <div class="value" id="email">—</div>
          </div>

          <div class="row">
            <a id="webIcon" class="iconBox iconLink" href="#" target="_blank" rel="noopener" aria-label="Website">
              <svg viewBox="0 0 24 24">
                <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm7.93 9h-3.18a15.7 15.7 0 00-2.06-5.58A8.02 8.02 0 0119.93 11zM12 4.07c1.02 1.35 1.86 3.55 2.14 6.93H9.86c.28-3.38 1.12-5.58 2.14-6.93zM4.07 13h3.18c.23 2.12.9 4.02 2.06 5.58A8.02 8.02 0 014.07 13zm3.18-2H4.07a8.02 8.02 0 015.24-5.58A15.7 15.7 0 007.25 11zM12 19.93c-1.02-1.35-1.86-3.55-2.14-6.93h4.28c-.28 3.38-1.12 5.58-2.14 6.93zM16.75 13h3.18a8.02 8.02 0 01-5.24 5.58c1.16-1.56 1.83-3.46 2.06-5.58z"/>
              </svg>
            </a>
            <div class="value" id="website">—</div>
          </div>

          <div class="row addressRow">
            <span class="iconBox" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/>
              </svg>
            </span>
            <div class="addressBlock">
              <div class="companyName">DDS Engineering (INDIA) Pvt. Ltd.</div>
              <a class="addrText addrLink" id="address" href="#" target="_blank" rel="noopener">—</a>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
const PROFILE_ROOT = "https://visargbhatporiya.github.io/employee-icard/";

/* ✅ FIXED LOGO (NOT from employees.json)
   You already have: employee-icard/assets/logo.png
   This code auto-detects correct path (inner/outer live-server root)
*/
const FIXED_LOGO_CLICK_URL = "https://www.ddsengineering.in";

let EMPLOYEES = [];
let CURRENT_EMP = null;

let CURRENT_PROFILE_URL = "";
let CURRENT_WEB_URL = "";
let CURRENT_TEL_URL = "";
let CURRENT_MAIL_URL = "";
let CURRENT_MAP_URL = "";

function text(id, v){ document.getElementById(id).textContent = (v && String(v).trim()) ? v : "—"; }
function html(id, v){ document.getElementById(id).innerHTML = v || "—"; }

function normalizeUrl(url){
  if(!url) return "";
  const u = String(url).trim();
  if(!u) return "";
  if(u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u;
}

function buildProfileUrl(empId){ return `${PROFILE_ROOT}?id=${encodeURIComponent(empId)}`; }

function buildMapUrl(addr){
  const a = (addr || "").toString().trim();
  if(!a || a === "—") return "";
  return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(a);
}

function setIconLink(el, href){
  if(!el) return;
  if(href){ el.href = href; el.style.pointerEvents="auto"; el.style.opacity="1"; }
  else{ el.href="#"; el.style.pointerEvents="none"; el.style.opacity=".45"; }
}

function waitForImg(img){
  return new Promise((resolve) => {
    if(!img) return resolve();
    if(img.complete && img.naturalWidth > 0) return resolve();
    img.onload = () => resolve();
    img.onerror = () => resolve();
  });
}

async function decodeImg(img){
  try{ if(img && img.decode) await img.decode(); }catch(e){}
}

async function makeQrDataUrl(data){
  try{
    if(window.QRCode && QRCode.toDataURL){
      return await QRCode.toDataURL(String(data || ""), { width: 400, margin: 0 });
    }
  }catch(e){ console.warn("QR generation failed, fallback", e); }
  const d = encodeURIComponent(data || "");
  return `https://api.qrserver.com/v1/create-qr-code/?size=400x400&margin=0&data=${d}`;
}

/* ✅ Load logo using working path (tries both) */
function applyFixedLogo(){
  const logoImg = document.getElementById("logoImg");
  const logoLink = document.getElementById("logoLink");

  const candidates = [
    "./assets/images/logo/logo.png",              // when server root = employee-icard/
    "./employee-icard/assets/images/logo/logo.png"// when server root = outer folder
  ];

  let i = 0;

  const tryNext = () => {
    const src = candidates[i] + "?v=" + Date.now(); // cache buster
    logoImg.src = src;

    logoImg.onerror = () => {
      i++;
      if(i < candidates.length) tryNext();
      else console.log("❌ Logo not found. Checked:", candidates);
    };
  };

  tryNext();

  if(FIXED_LOGO_CLICK_URL){
    logoLink.href = FIXED_LOGO_CLICK_URL;
    logoLink.style.pointerEvents = "auto";
    logoLink.style.opacity = "1";
  }else{
    logoLink.href = "#";
    logoLink.style.pointerEvents = "none";
    logoLink.style.opacity = ".7";
  }
}

function setEmployee(e){
  CURRENT_EMP = e;

  const name = e.name || e.fullName || e.employeeName || "—";
  const des  = e.designation || e.role || e.title || "—";
  const address = e.address || e.location || e.addr || "—";

  const phone = (e.phone || e.mobile || e.contact || "").toString().trim();
  const email = (e.email || e.mail || "").toString().trim();
  const websiteRaw = (e.website || e.web || e.site || "").toString().trim();
  const websiteUrl = websiteRaw ? normalizeUrl(websiteRaw) : "";

  text("name", name);
  text("designation", des);

  CURRENT_MAP_URL = buildMapUrl(address);
  const addrEl = document.getElementById("address");
  if(addrEl){
    addrEl.textContent = (address && String(address).trim()) ? address : "—";
    if(CURRENT_MAP_URL){
      addrEl.href = CURRENT_MAP_URL;
      addrEl.style.pointerEvents = "auto";
      addrEl.style.opacity = "1";
    }else{
      addrEl.href = "#";
      addrEl.style.pointerEvents = "none";
      addrEl.style.opacity = ".9";
    }
  }

  CURRENT_TEL_URL = phone ? `tel:${phone.replace(/\s+/g,"")}` : "";
  CURRENT_MAIL_URL = email ? `mailto:${email}` : "";
  CURRENT_WEB_URL  = websiteRaw ? websiteUrl : "";

  if(phone)  html("phone", `<a href="${CURRENT_TEL_URL}">${phone}</a>`); else text("phone","—");
  if(email)  html("email", `<a href="${CURRENT_MAIL_URL}">${email}</a>`); else text("email","—");

  if(websiteRaw){
    const showText = websiteRaw.replace(/^https?:\/\//i, "").replace(/\/+$/,"");
    html("website", `<a href="${CURRENT_WEB_URL}" target="_blank" rel="noopener">${showText}</a>`);
  }else text("website","—");

  setIconLink(document.getElementById("phoneIcon"), CURRENT_TEL_URL);
  setIconLink(document.getElementById("emailIcon"), CURRENT_MAIL_URL);
  setIconLink(document.getElementById("webIcon"), CURRENT_WEB_URL);

  const fallbackIndex = document.getElementById("empSelect").value || "0";
  const empId = (e.id || e.empId || e.slug || fallbackIndex);
  CURRENT_PROFILE_URL = buildProfileUrl(empId);
  document.getElementById("openProfileBtn").href = CURRENT_PROFILE_URL;

  const qrEl = document.getElementById("qrImg");
  makeQrDataUrl(CURRENT_PROFILE_URL).then(src => { qrEl.src = src; });
}

async function loadEmployees(){
  const sel = document.getElementById("empSelect");
  sel.innerHTML = `<option>Loading…</option>`;

  try{
    const res = await fetch("./employees.json", { cache:"no-store" });
    if(!res.ok) throw new Error("employees.json not found");
    const data = await res.json();

    EMPLOYEES = Array.isArray(data) ? data : (data.employees || []);
    if(!EMPLOYEES.length) throw new Error("No employees in JSON");

    sel.innerHTML = "";
    EMPLOYEES.forEach((e,i)=>{
      const label = e.name || e.fullName || e.employeeName || `Employee ${i+1}`;
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = label;
      sel.appendChild(opt);
    });

    sel.onchange = () => setEmployee(EMPLOYEES[Number(sel.value)]);
    sel.value = "0";
    setEmployee(EMPLOYEES[0]);

    // ✅ apply fixed logo once
    applyFixedLogo();

  }catch(err){
    console.error(err);
    sel.innerHTML = `<option>Error: ${err.message}</option>`;
  }
}

/** Add clickable rectangle (in inches) */
function addLink(pdf, url, x, y, w, h){
  if(!url) return;
  pdf.link(x, y, w, h, { url });
}

async function downloadCardPdf(){
  const card = document.getElementById("printCard");
  const logoImg = document.getElementById("logoImg");
  const qrImg = document.getElementById("qrImg");

  document.body.classList.add("exporting");
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

  if (typeof applyFixedLogo === "function") applyFixedLogo();

  if (document.fonts?.ready) { try { await document.fonts.ready; } catch(e){} }
  await Promise.all([waitForImg(logoImg), waitForImg(qrImg)]);

  const rect = card.getBoundingClientRect();
  const SCALE = 4;

  const canvas = await html2canvas(card, {
    backgroundColor: "#ffffff",
    scale: SCALE,
    width: rect.width,
    height: rect.height,
    useCORS: true,
    allowTaint: false,
    logging: false,

    onclone: (doc) => {

      /* =========================
         ✅ PDF ONLY FIX: NORMAL ROWS
         ========================= */
      const normalRows = doc.querySelectorAll(".row:not(.addressRow)");
      normalRows.forEach(r => {
        r.style.display = "flex";
        r.style.alignItems = "center";
        r.style.gap = "10px";
      });

      const normalIcons = doc.querySelectorAll(".row:not(.addressRow) .iconBox");
      normalIcons.forEach(icon => {
        icon.style.display = "flex";
        icon.style.alignItems = "center";
        icon.style.justifyContent = "center";
        icon.style.transform = "translateY(1px)";
      });

      /* =========================
         ✅ PDF ONLY FIX: ADDRESS ROW (TOP ALIGN LIKE SCREEN)
         ========================= */
      const addrRow = doc.querySelector(".addressRow");
      if (addrRow){
        addrRow.style.display = "flex";
        addrRow.style.alignItems = "flex-start";   // IMPORTANT (matches screenshot 1)
        addrRow.style.gap = "10px";
      }

      const locationIcon = doc.querySelector(".addressRow .iconBox");
      if(locationIcon){
        locationIcon.style.display = "flex";
        locationIcon.style.alignItems = "center";
        locationIcon.style.justifyContent = "center";
        locationIcon.style.transform = "translateY(2px)"; // aligns with DDS Engineering line
      }

      /* =========================
         ✅ Keep ORIGINAL LOGO SHAPE
         ========================= */
      const l  = doc.getElementById("logoImg");
      const ll = doc.getElementById("logoLink");

      if (ll){
        ll.style.width = "";
        ll.style.height = "";
        ll.style.borderRadius = "0";
        ll.style.overflow = "hidden";
        ll.style.clipPath = "none";
        ll.style.webkitClipPath = "none";
        ll.style.display = "flex";
        ll.style.alignItems = "center";
        ll.style.justifyContent = "center";
      }

      if (l){
        l.style.width = "100%";
        l.style.height = "100%";
        l.style.objectFit = "contain";
        l.style.borderRadius = "0";
        l.style.clipPath = "none";
        l.style.webkitClipPath = "none";
        l.style.display = "block";
      }

      /* =========================
         ✅ Ensure Name not uppercase in PDF
         ========================= */
      const nameEl = doc.querySelector(".name");
      if(nameEl){
        nameEl.style.textTransform = "none";
      }
    }
  });

  const imgData = canvas.toDataURL("image/png", 1.0);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: "landscape",
    unit: "in",
    format: [3.5, 2],
    compress: false
  });

  pdf.addImage(imgData, "PNG", 0, 0, 3.5, 2, undefined, "NONE");

  addLink(pdf, FIXED_LOGO_CLICK_URL || CURRENT_WEB_URL, 0.22, 0.18, 1.05, 0.85);
  addLink(pdf, CURRENT_PROFILE_URL, 0.36, 1.12, 0.70, 0.70);
  addLink(pdf, CURRENT_TEL_URL,     1.55, 0.55, 1.85, 0.22);
  addLink(pdf, CURRENT_MAIL_URL,    1.55, 0.80, 1.85, 0.22);
  addLink(pdf, CURRENT_WEB_URL,     1.55, 1.05, 1.85, 0.22);
  addLink(pdf, CURRENT_MAP_URL,     1.55, 1.30, 1.85, 0.60);

  const safeName = (document.getElementById("name")?.textContent || "card")
    .trim().replace(/\s+/g, "-").replace(/[^a-z0-9\-]/gi, "");

  pdf.save(`${safeName || "qr-card"}.pdf`);

  document.body.classList.remove("exporting");
}
document.getElementById("pdfBtn").addEventListener("click", downloadCardPdf);
loadEmployees();
</script>

</body>
</html>
